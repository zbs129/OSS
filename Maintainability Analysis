import xml.etree.ElementTree as ET
import re
from typing import Dict, List, Tuple

class XMLMaintainabilityAnalyzer:
    def __init__(self, file_path: str):
        self.file_path = file_path
        self.tree = None
        self.root = None
        self.issues = []  # 存储可维护性问题
        self.readability_score = 100  # 初始可读性满分
        self.load_xml()

    def load_xml(self):
        """加载XML文件并捕获基础异常"""
        try:
            self.tree = ET.parse(self.file_path)
            self.root = self.tree.getroot()
        except FileNotFoundError:
            self.issues.append(f"[严重] 文件不存在: {self.file_path}")
            self.readability_score -= 50
        except ET.ParseError as e:
            self.issues.append(f"[严重] XML语法错误: {str(e)}")
            self.readability_score -= 80
        except Exception as e:
            self.issues.append(f"[未知] 文件加载失败: {str(e)}")
            self.readability_score -= 30

    def check_config_norm(self) -> List[str]:
        """检查配置规范性（命名、版本、必填项）"""
        norm_issues = []
        if not self.root:
            return norm_issues
        
        # 1. 检查project版本格式（数字+小数点）
        project_version = self.root.get("version")
        if project_version and not re.match(r"^\d+(\.\d+)?$", project_version):
            norm_issues.append(f"[规范] project版本格式不规范: {project_version}（建议：纯数字/数字+小数点）")
            self.readability_score -= 10
        
        # 2. 检查Python SDK命名规范性（避免特殊字符）
        for component in self.root.findall("component"):
            comp_name = component.get("name")
            if comp_name == "ProjectRootManager":
                jdk_name = component.find("option[@name='project-jdk-name']")
                if jdk_name:
                    jdk_val = jdk_name.get("value")
                    if jdk_val and re.search(r"[^\w\s\(\)]", jdk_val):
                        norm_issues.append(f"[规范] Python SDK名称含特殊字符: {jdk_val}（易导致解析异常）")
                        self.readability_score -= 15
        
        return norm_issues

    def detect_duplicate_config(self) -> List[str]:
        """检测重复配置项（可维护性低，易冲突）"""
        duplicate_issues = []
        if not self.root:
            return duplicate_issues
        
        component_names = []
        for component in self.root.findall("component"):
            comp_name = component.get("name")
            if comp_name in component_names:
                duplicate_issues.append(f"[重复] 存在重复的component配置: {comp_name}（建议合并）")
                self.readability_score -= 20
            else:
                component_names.append(comp_name)
        
        return duplicate_issues

    def check_version_compatibility(self) -> List[str]:
        """检查版本兼容性（以Python SDK为例）"""
        compat_issues = []
        if not self.root:
            return compat_issues
        
        for component in self.root.findall("component"):
            if component.get("name") == "ProjectRootManager":
                jdk_name = component.find("option[@name='project-jdk-name']")
                if jdk_name:
                    jdk_val = jdk_name.get("value")
                    # 检查Python版本是否为主流支持版本（3.8+）
                    if "Python" in jdk_val:
                        version_match = re.search(r"Python (\d+\.\d+)", jdk_val)
                        if version_match:
                            version = float(version_match.group(1))
                            if version < 3.8:
                                compat_issues.append(f"[兼容] Python版本{version}过低（建议升级至3.8+，减少维护成本）")
                                self.readability_score -= 10
        
        return compat_issues

    def calculate_maintainability_score(self) -> int:
        """计算整体可维护性得分（0-100）"""
        final_score = max(0, self.readability_score)
        return final_score

    def generate_report(self) -> str:
        """生成可视化分析报告"""
        # 收集所有问题
        norm_issues = self.check_config_norm()
        duplicate_issues = self.detect_duplicate_config()
        compat_issues = self.check_version_compatibility()
        all_issues = norm_issues + duplicate_issues + compat_issues
        self.issues.extend(all_issues)

        # 生成报告
        report = f"""
# XML配置文件可维护性分析报告
## 文件路径: {self.file_path}
## 整体可维护性得分: {self.calculate_maintainability_score()}/100

### 一、问题明细
"""
        if self.issues:
            for idx, issue in enumerate(self.issues, 1):
                report += f"{idx}. {issue}\n"
        else:
            report += "✅ 未检测到可维护性问题\n"

        report += f"""
### 二、优化建议
1. 配置规范性：统一版本格式、避免SDK名称含特殊字符，降低解析故障概率
2. 重复配置：合并重复的component节点，减少配置冗余
3. 版本兼容：升级低版本依赖（如Python 3.8+），减少长期维护成本
4. 可读性：保持XML缩进统一、节点命名语义化（当前文件未检测到缩进问题）

### 三、可维护性等级
"""
        score = self.calculate_maintainability_score()
        if score >= 90:
            grade = "优秀"
        elif score >= 70:
            grade = "良好"
        elif score >= 50:
            grade = "一般"
        else:
            grade = "较差"
        report += f"当前文件可维护性等级：{grade}（得分{score}）"

        return report

# ---------------------- 执行分析 ----------------------
if __name__ == "__main__":
    # 替换为你的文件路径
    analyzer = XMLMaintainabilityAnalyzer("OSS/.idea/misc.xml")
    # 生成并打印分析报告
    print(analyzer.generate_report())
